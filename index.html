<!DOCTYPE html>
<html lang="en-IE">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MMM Drone Services â€” Operations Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #00ff95; 
            --dark: #05080a;    
            --accent: #1e293b;
            --text: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; }
        body { background: var(--dark); color: var(--text); overflow-x: hidden; }

        #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); display: flex; align-items: center; 
            justify-content: center; z-index: 9999; transition: opacity 0.5s;
        }

        nav {
            padding: 0.8rem 5%; display: flex; justify-content: space-between;
            align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000;
            background: rgba(5, 8, 10, 0.95); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--primary);
        }

        .nav-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: white; }
        /* Logo styling for the PostImage link */
        .nav-logo img { height: 50px; width: auto; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }

        .container { padding: 120px 5% 40px; }
        .btn-row { display: flex; gap: 15px; margin-bottom: 30px; }
        
        .btn { padding: 0.8rem 1.8rem; border-radius: 4px; border: none; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: var(--dark); }
        .btn-excel { background: #ffffff; color: var(--dark); }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }

        .board { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; }
        .column { flex: 1; min-width: 300px; background: var(--accent); border-radius: 8px; padding: 1.5rem; min-height: 500px; border: 1px solid rgba(255,255,255,0.05); }
        .column h4 { color: var(--primary); margin-bottom: 1.5rem; letter-spacing: 2px; text-transform: uppercase; font-size: 0.85rem; }

        .card { 
            background: #000; padding: 1.2rem; border-radius: 6px; 
            margin-bottom: 1rem; border-left: 4px solid var(--primary);
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .history-table { width: 100%; border-collapse: collapse; margin-top: 50px; background: #000; border-radius: 8px; overflow: hidden; }
        th { text-align: left; color: var(--primary); padding: 15px; border-bottom: 2px solid var(--primary); font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #111; font-size: 0.85rem; color: rgba(255,255,255,0.8); }

        footer { text-align: center; padding: 4rem; opacity: 0.4; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div id="app-loader">
        <h2 style="color: var(--primary); font-weight: 900; letter-spacing: 4px;">MMM COMMAND CENTER</h2>
    </div>

    <nav>
        <a href="#" class="nav-logo">
            <img src="https://i.postimg.cc/mD8xM5pL/MMM-Platforms-logo.jpg" alt="MMM Platforms">
            <span style="font-weight: 900;">MMM PLATFORMS</span>
        </a>
        <div style="text-align: right; line-height: 1.2;">
            <div style="font-size: 0.7rem; font-weight: 900;">1ST CLASS SERVICES</div>
            <div style="font-size: 0.6rem; color: var(--primary); font-weight: 700;">ZERO EMISSIONS</div>
        </div>
    </nav>

    <div class="container">
        <div class="btn-row">
            <button class="btn btn-primary" onclick="window.orderFlow.place()">+ New Mission</button>
            <button class="btn btn-excel" onclick="window.orderFlow.export()">ðŸ“Š Excel Logs</button>
        </div>

        <div class="board">
            <div class="column"><h4>New Missions</h4><div id="list-New"></div></div>
            <div class="column"><h4>In Flight</h4><div id="list-InFlight"></div></div>
            <div class="column"><h4>Delivered</h4><div id="list-Delivered"></div></div>
        </div>

        <div style="margin-top: 60px;">
            <h3 style="font-weight: 900; font-size: 1.2rem; color: var(--primary);">MISSION HISTORY TRAIL</h3>
            <table class="history-table">
                <thead>
                    <tr><th>TIME</th><th>CLIENT</th><th>SERVICE</th><th>STATUS</th></tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>

    <footer>Â© 2024 MMM Platforms â€¢ Mzwandile Hlophe</footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA42AEfO6mGGSTKa-2QcR9hFEj3xBhRuoc",
            authDomain: "live-order-board-ab721.firebaseapp.com",
            projectId: "live-order-board-ab721",
            storageBucket: "live-order-board-ab721.firebasestorage.app",
            messagingSenderId: "157405136208",
            appId: "1:157405136208:web:074c852dbae6a46a305855"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let logData = [];

        window.orderFlow = {
            async place() {
                const client = prompt("Client Name:");
                const type = prompt("Service (Agri / Courier):");
                if(!client || !type) return;
                try {
                    await addDoc(collection(db, "orders"), {
                        client, type, status: 'New', timestamp: new Date().getTime(), createdAt: serverTimestamp()
                    });
                } catch(e) { console.error("Error adding document: ", e); }
            },
            export() {
                if(logData.length === 0) return alert("No data to export.");
                const ws = XLSX.utils.json_to_sheet(logData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "MissionLogs");
                XLSX.writeFile(wb, "MMM_Drone_Operations.xlsx");
            }
        };

        const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const cols = { 'New': document.getElementById('list-New'), 'InFlight': document.getElementById('list-InFlight'), 'Delivered': document.getElementById('list-Delivered') };
            Object.values(cols).forEach(el => el.innerHTML = '');
            document.getElementById('history-body').innerHTML = '';
            logData = [];

            snap.forEach((d) => {
                const data = d.data();
                
                // DATA VALIDATION FIX: Ensuring fields are not undefined
                const name = data.client || "Unspecified Client";
                const svc = data.type || "General Mission";
                const status = data.status || "New";
                const rawTime = data.timestamp || Date.now();
                const timeStr = new Date(rawTime).toLocaleString('en-ZA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                logData.push({ "Time": timeStr, "Client": name, "Service": svc, "Status": status });

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div style="font-weight:900; font-size:1rem;">${name}</div><div style="font-size:0.7rem; color:var(--primary); font-weight:700;">${svc}</div>`;
                
                if(cols[status]) cols[status].appendChild(card);

                const row = `<tr><td>${timeStr}</td><td>${name}</td><td>${svc}</td><td>${status}</td></tr>`;
                document.getElementById('history-body').insertAdjacentHTML('beforeend', row);
            });
            
            // Remove loader once data is synced
            const loader = document.getElementById('app-loader');
            if(loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        }, (error) => {
            console.error("Firebase Snapshot Error:", error);
            document.getElementById('app-loader').innerHTML = `<h3 style="color:red">Connection Error. Check Internet.</h3>`;
        });
    </script>
</body>
</html>
